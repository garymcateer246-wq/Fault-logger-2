
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Machinery Fault Logger</title>
<style>
body { font-family: Arial; margin: 15px; background:#f4f6f8; }
h1 { text-align:center; }
input, textarea, select, button {
  width:100%; padding:8px; margin:5px 0; font-size:14px;
}
button { background:#007aff; color:white; border:none; cursor:pointer; }
button:hover { opacity:0.9; }
.card {
  background:white; padding:10px; margin:10px 0;
  border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.filters { background:white; padding:10px; border-radius:8px; }
img { max-width:100%; margin-top:5px; border-radius:6px; }
.small-btn { width:auto; padding:5px 10px; font-size:12px; margin-right:5px; }
</style>
</head>
<body>

<h1>Machinery Fault Logger</h1>

<h3>Add Fault</h3>
<input id="machine" placeholder="Machine">
<input id="subdivision" placeholder="Subdivision">
<input id="fault" placeholder="Fault Description">
<textarea id="action" placeholder="Action Taken"></textarea>
<input id="stores" placeholder="Stores Location / Parts">
<input id="manual" placeholder="Manual Chapter / Page">
<input type="date" id="date">
<input type="file" id="photo" accept="image/*">
<button onclick="addFault()">Save Fault</button>

<h3>Search & Filters</h3>
<div class="filters">
<input id="search" placeholder="Search all fields" oninput="render()">
<input id="filterMachine" placeholder="Filter by Machine" oninput="render()">
<input type="date" id="filterDate" onchange="render()">
<button onclick="exportCSV()">Export CSV</button>
<button onclick="clearAll()">Clear All Data</button>
</div>

<h3>Fault Logs</h3>
<div id="logs"></div>

<script>
let faults = JSON.parse(localStorage.getItem("faults")) || [];

function saveData() {
  localStorage.setItem("faults", JSON.stringify(faults));
}

function addFault() {
  const file = document.getElementById("photo").files[0];
  const reader = new FileReader();

  reader.onload = function() {
    const newFault = {
      id: Date.now(),
      machine: machine.value,
      subdivision: subdivision.value,
      fault: fault.value,
      action: action.value,
      stores: stores.value,
      manual: manual.value,
      date: date.value,
      photo: reader.result || ""
    };
    faults.push(newFault);
    saveData();
    document.querySelectorAll("input, textarea").forEach(el => el.value="");
    render();
  };

  if (file) {
    reader.readAsDataURL(file);
  } else {
    reader.onload();
  }
}

function deleteFault(id) {
  faults = faults.filter(f => f.id !== id);
  saveData();
  render();
}

function render() {
  const searchText = search.value.toLowerCase();
  const filterMachineText = filterMachine.value.toLowerCase();
  const filterDateValue = filterDate.value;

  const filtered = faults.filter(f =>
    (f.machine.toLowerCase().includes(searchText) ||
     f.subdivision.toLowerCase().includes(searchText) ||
     f.fault.toLowerCase().includes(searchText) ||
     f.action.toLowerCase().includes(searchText) ||
     f.stores.toLowerCase().includes(searchText) ||
     f.manual.toLowerCase().includes(searchText))
    &&
    f.machine.toLowerCase().includes(filterMachineText)
    &&
    (filterDateValue === "" || f.date === filterDateValue)
  );

  logs.innerHTML = "";

  filtered.reverse().forEach(f => {
    logs.innerHTML += `
      <div class="card">
        <b>Machine:</b> ${f.machine}<br>
        <b>Subdivision:</b> ${f.subdivision}<br>
        <b>Date:</b> ${f.date}<br>
        <b>Fault:</b> ${f.fault}<br>
        <b>Action:</b> ${f.action}<br>
        <b>Stores:</b> ${f.stores}<br>
        <b>Manual:</b> ${f.manual}<br>
        ${f.photo ? `<img src="${f.photo}">` : ""}
        <br>
        <button class="small-btn" onclick="deleteFault(${f.id})">Delete</button>
      </div>
    `;
  });
}

function exportCSV() {
  let csv = "Machine,Subdivision,Date,Fault,Action,Stores,Manual\n";
  faults.forEach(f => {
    csv += `"${f.machine}","${f.subdivision}","${f.date}","${f.fault}","${f.action}","${f.stores}","${f.manual}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "fault_logs.csv";
  a.click();
}

function clearAll() {
  if(confirm("Delete ALL fault logs?")) {
    faults = [];
    saveData();
    render();
  }
}

render();
</script>

</body>
</html>
